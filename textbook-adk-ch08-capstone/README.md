# Chapter 8 Capstone: Research Grounding Panel Implementation

Complete implementation of the Research Grounding Panel using real ADK events and the ADK UI Contract.

## Overview

This capstone project demonstrates:
- **Real ADK events** (no custom extensions)
- **ADK UI Contract compliance** (POST /run, POST /run_sse, session endpoints)
- **Research grounding middleware** from `nudge_middleware_plan/`
- **Mock services** (SessionService, MemoryService, ArtifactService) for standalone operation
- **Web-based grounding panel** consuming SSE stream

## Architecture

```
┌─────────────────────────────────────────────────────────┐
│              Web UI (Grounding Panel)                   │
│  • Chat box (user input)                                │
│  • Grounding box display (state visualization)          │
│  • Approval buttons (OK/Short Run/Modify/Cancel)        │
│  • Turn receipts timeline                               │
└────────────────────┬────────────────────────────────────┘
                     │ SSE Stream
                     │ POST /run_sse
                     ↓
┌─────────────────────────────────────────────────────────┐
│         FastAPI Server (ADK UI Contract)                │
│  • POST /run_sse → stream events                        │
│  • POST /run → batch events                             │
│  • Session management (GET/POST/DELETE)                 │
└────────────────────┬────────────────────────────────────┘
                     │
                     ↓
┌─────────────────────────────────────────────────────────┐
│          ADK Runner + Research Agent                    │
│  • Mock SessionService (in-memory)                      │
│  • Mock MemoryService (in-memory)                       │
│  • Mock ArtifactService (in-memory)                     │
│  • Grounding state tools                                │
│  • Search plan presentation tools                       │
└─────────────────────────────────────────────────────────┘
```

## Project Structure

```
textbook-adk-ch08-capstone/
├── README.md                      # This file
├── server.py                      # FastAPI server (ADK UI Contract)
├── agent/
│   ├── __init__.py
│   ├── research_agent.py          # Main agent with grounding
│   └── tools/
│       ├── __init__.py
│       ├── grounding_tools.py     # State management tools
│       ├── search_tools.py        # Mock database search tools
│       └── plan_tools.py          # Search plan presentation
├── services/
│   ├── __init__.py
│   ├── mock_session_service.py    # In-memory session service
│   ├── mock_memory_service.py     # In-memory memory service
│   └── mock_artifact_service.py   # In-memory artifact service
├── templates/
│   └── index.html                 # Main UI page
├── static/
│   ├── css/
│   │   └── styles.css             # Grounding panel styles
│   └── js/
│       ├── app.js                 # Main application logic
│       ├── grounding-panel.js     # Grounding box component
│       ├── chat.js                # Chat box component
│       └── sse-client.js          # SSE stream consumer
└── requirements.txt               # Python dependencies
```

## Setup

### 1. Install Dependencies

```bash
cd textbook-adk-ch08-capstone
uv venv
source .venv/bin/activate  # or .venv\Scripts\activate on Windows
uv pip install -r requirements.txt
```

### 2. Set Environment Variables

Create `.env` file:
```bash
GOOGLE_API_KEY=your_key_here  # For Gemini model
```

### 3. Run the Server

```bash
python server.py
```

Server starts at `http://localhost:8000`

## Usage

### Access the UI

Open browser: `http://localhost:8000`

### Interact with Research Agent

1. **Type in chat box**: "Search Semantic Scholar for explainable AI"
2. **Agent presents search plan** with [OK][Short Run][Modify][Cancel] buttons
3. **Click [OK]** to approve
4. **Agent executes search** and updates grounding panel
5. **View grounding box** showing:
   - Research question
   - Stage (scoping/retrieval/synthesis/validation)
   - Papers found
   - Databases searched
   - Next action
6. **See turn receipt** below grounding panel

### Grounding Panel Features

- **Real-time updates** via SSE
- **Δ highlighting** for changed fields
- **Search history** timeline
- **Export strategy** button (downloads methods section)
- **Direct state mutation** (add/remove assumptions)

## ADK Events Reference

All events follow Google's [ADK Events specification](https://google.github.io/adk-docs/events/).

### Events Consumed by Panel

1. **User Input Events** (`author: "user"`)
2. **Agent Response Events** (`author: "research_agent"`)
3. **Tool Call Events** (function_calls)
4. **Tool Result Events** (function_responses)
5. **State Update Events** (actions.state_delta)
6. **Turn Complete Events** (turn_complete: true)

### Events Generated by Panel

1. **Chat box** → User input with free text
2. **[OK] button** → User input "OK" + state_delta
3. **[Short Run] button** → User input "Short Run" + state_delta
4. **[Modify] button** → User input "Modify" + state_delta
5. **[Cancel] button** → User input "Cancel" + state_delta
6. **[Add Assumption]** → System message with state_delta only

See `nudge_middleware_plan/ADK_EVENTS_CONTRACT.md` for complete specification.

## Mock Services

### MockSessionService

Stores sessions in memory (Python dict). Implements:
- `create_session(app_name, user_id, session_id, state)`
- `get_session(app_name, user_id, session_id)`
- `list_sessions(app_name, user_id)`
- `delete_session(app_name, user_id, session_id)`
- `update_state(app_name, user_id, session_id, state_delta)`

### MockMemoryService

In-memory memory storage (not used in this demo).

### MockArtifactService

In-memory artifact storage. Implements:
- `save_artifact(app_name, user_id, session_id, filename, data)`
- `load_artifact(app_name, user_id, session_id, filename)`
- `list_artifacts(app_name, user_id, session_id)`

## Grounding State Schema

Session state stores grounding box using these keys:

```python
{
    "grounding:research_question": str,
    "grounding:stage": str,  # scoping|retrieval|synthesis|validation
    "grounding:search_assumptions": List[str],
    "grounding:open_questions": List[str],
    "grounding:papers_found": int,
    "grounding:databases_searched": List[str],
    "grounding:next_action": {
        "owner": str,  # agent|researcher|both
        "action": str,
        "target": str,
        "due": str
    },
    "grounding:search_history": List[Dict],  # SearchReceipts
    "grounding:pending_search_plan": Dict | None
}
```

## Testing

### Test Chat Input

```
User: "Search Semantic Scholar for transformers in NLP"
```

Expected flow:
1. Agent presents search plan
2. Panel shows [OK][Short Run][Modify][Cancel]
3. Click [OK]
4. Agent executes mock search
5. Grounding panel updates: papers_found, databases_searched
6. Turn receipt appears

### Test Approval Buttons

Click each button and observe:
- **[OK]**: Full search executes
- **[Short Run]**: Preview with 10 results
- **[Modify]**: Agent asks what to change
- **[Cancel]**: Search cancelled

### Test State Mutation

1. Click [+ Add Assumption]
2. Enter: "Peer-reviewed only"
3. Observe grounding panel update with Δ marker

### Test Export

1. Complete a few searches
2. Click [Export Strategy]
3. Downloads `search_strategy.md` with complete methodology

## Integration with Book

This capstone integrates concepts from:

- **Chapter 2**: Agent with custom tools
- **Chapter 6**: ADK Runtime fundamentals, state management
- **Chapter 7**: Event sourcing patterns (simulated with mock services)
- **Nudge Middleware Plan**: Research grounding, mixed-initiative control

## Production Deployment

To move from mock services to production:

1. Replace `MockSessionService` with PostgreSQL implementation (see Chapter 7)
2. Replace `MockMemoryService` with vector database
3. Replace `MockArtifactService` with S3/GCS + database metadata
4. Add authentication/authorization
5. Add rate limiting
6. Configure CORS for production domains

## Troubleshooting

### SSE connection fails

Check browser console for errors. Ensure:
- Server running on correct port
- CORS headers configured
- Browser supports EventSource API

### Grounding panel not updating

Check that:
- Agent tools are emitting state_delta correctly
- SSE stream includes state update events
- JavaScript console shows no errors

### State persists across page refresh

This is expected - mock services are in-memory. For persistence:
- Use PostgreSQL SessionService (Chapter 7)
- Store state in database, not memory

## References

- ADK Events: https://google.github.io/adk-docs/events/
- ADK State Management: https://google.github.io/adk-docs/sessions/state/
- Nudge Middleware Plan: `../nudge_middleware_plan/`
- ADK Events Contract: `../nudge_middleware_plan/ADK_EVENTS_CONTRACT.md`

## License

Educational use for ADK Textbook project.
