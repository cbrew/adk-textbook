# ADK Web UI ↔ FastAPI Contract Notes

This document explains the contract between the Google ADK Angular Web UI (`adk-web`) and the FastAPI backend (`adk api_server`). It is written so a coding agent can consume and act on it.

---

## 1. Core Run Endpoints

### `POST /run`
- **Purpose:** Execute a message turn and return all resulting events at once.
- **Request body:**
```json
{
  "app_name": "my_app",
  "user_id": "u_123",
  "session_id": "s_123",
  "new_message": {
    "role": "user",
    "parts": [ { "text": "Talk to me about citation rings" } ]
  },
  "streaming": true,
  "state_delta": { "foo": "bar" }
}
```
- **Response:** JSON array of `Event` objects.

### `POST /run_sse`
- **Purpose:** Execute a message turn and return a Server-Sent Events (SSE) stream.
- **Request body:** Same as `/run`.
- **Response:** SSE stream, each `data:` line is a JSON `Event`.

### Event Model
Events can include:
- `content` (tokens, partial or complete)
- `tool_call`
- `tool_result`
- `state_delta`
- `artifact_delta`
- `error`
- `final` marker

The Angular UI renders these as they arrive.

---

## 2. Session Endpoints

### `GET /apps/{app_name}/users/{user_id}/sessions`
- Returns list of session metadata (`id`, timestamps, optional state).

### `POST /apps/{app_name}/users/{user_id}/sessions/{session_id}`
- Creates a new session.
- Body may include initial `state`.

### `DELETE /apps/{app_name}/users/{user_id}/sessions/{session_id}`
- Deletes a session.

### Notes
- The UI uses these for the sidebar session picker.
- State updates are usually passed via `state_delta` in `/run` or `/run_sse`.

---

## 3. State Mutation Outside of User Turns

You can mutate session state without sending user text:

```http
POST /run_sse
Content-Type: application/json

{
  "app_name": "legal_research_agent",
  "user_id": "u_123",
  "session_id": "s_123",
  "new_message": { "role": "system", "parts": [] },
  "state_delta": { "topic": "citations" }
}
```

This commits a state change to the session. The UI will receive a `state` Event and reflect the update.

---

## 4. Memory

- The **MemoryService** is only used server-side (by the agent).
- The Angular UI does **not** call a REST Memory API.
- Memory influences outputs, which appear as Events.

---

## 5. Artifacts

- Inside agent code: use `context.save_artifact()`, `context.load_artifact()`, `context.list_artifacts()`.
- UI sees artifact changes via `artifact_delta` Events.
- There is no standard REST endpoint for saving artifacts from the browser.
- Some deployments add:
  - `GET /apps/{app}/users/{user}/sessions/{session}/artifacts`
  - `GET /apps/{app}/users/{user}/sessions/{session}/artifacts/{filename}`

---

## 6. Practical Guidance

- If you keep `/run_sse`, `/run`, and the sessions endpoints **API-compatible**, you can replace Session/Memory/Artifact services freely.
- If you need different endpoints or payloads, fork the `adk-web` Angular repo and adjust its data services.
- Serving the stock `adk web` UI (`get_fast_api_app(web=True)`) only works with the default contracts.

---

## TL;DR

- **Hard contract:** `/run` + `/run_sse` payloads and `Event` schema, sessions list/create.
- **Not a browser contract:** Memory REST, Artifact save REST.
- **Pattern for state-only updates:** pass `state_delta` with empty message.


---

## Notes on `state_delta` Beyond Callbacks

The ADK docs explain how **`state_delta`** is captured automatically when you mutate `context.state` inside a callback or tool ([State documentation](https://google.github.io/adk-docs/sessions/state/?utm_source=chatgpt.com)).  

However, **you are not limited to callbacks**. Another component (for example, an orchestration layer, a UI control panel, or an external service) can safely inject its own `state_delta` into the session without breaking contracts, as long as it uses the same mechanism the runner expects:

- **Attach a `state_delta` in the `/run` or `/run_sse` request body.**
  ```json
  {
    "app_name": "legal_research_agent",
    "user_id": "u_123",
    "session_id": "s_123",
    "new_message": { "role": "system", "parts": [] },
    "state_delta": { "topic": "citations" }
  }
  ```

- The Runner merges this delta into the session state and emits a `state` event, just as it would for state changes generated by an agent callback.

- This keeps the **contract intact** because:
  1. The shape of `state_delta` is the same (a shallow JSON object).
  2. Updates are still event-sourced — the new state is tied to a specific event in the session history.
  3. The UI and downstream components don’t care where the delta originated; they just replay events.

### Practical Guidance
- Use `state_delta` for *all* state mutations, whether from callbacks or external triggers.  
- Avoid trying to mutate session state directly in the store/service; always go through the Runner so the event log and state remain consistent.  
- This way, your external component can add or override values without diverging from the ADK’s event contract.
